<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è´§å¸æŠ€æœ¯åˆ†æä»ªè¡¨æ¿</title>
    
    <!-- å¼•å…¥Chart.jsç”¨äºå›¾è¡¨å±•ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- å¼•å…¥Bootstrapç”¨äºæ ·å¼ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .indicator-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .indicator-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .indicator-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .signal-badge {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        
        .signal-bullish {
            background-color: #28a745;
            color: white;
        }
        
        .signal-bearish {
            background-color: #dc3545;
            color: white;
        }
        
        .signal-neutral {
            background-color: #6c757d;
            color: white;
        }
        
        .signal-overbought {
            background-color: #fd7e14;
            color: white;
        }
        
        .signal-oversold {
            background-color: #20c997;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 2rem;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">ğŸš€ åŠ å¯†è´§å¸æŠ€æœ¯åˆ†æä»ªè¡¨æ¿</h1>
                    <p class="mb-0 mt-2">å®æ—¶æŠ€æœ¯æŒ‡æ ‡åˆ†æä¸äº¤æ˜“ä¿¡å·</p>
                </div>
                <div class="col-md-4 text-end">
                    <div id="lastUpdate" class="small">
                        æœ€åæ›´æ–°: --
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="symbolSelect" class="form-label">é€‰æ‹©å¸ç§</label>
                    <select id="symbolSelect" class="form-select">
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="ADA">Cardano (ADA)</option>
                        <option value="DOT">Polkadot (DOT)</option>
                        <option value="LINK">Chainlink (LINK)</option>
                        <option value="LTC">Litecoin (LTC)</option>
                        <option value="XRP">Ripple (XRP)</option>
                        <option value="BNB">Binance Coin (BNB)</option>
                        <option value="SOL">Solana (SOL)</option>
                        <option value="MATIC">Polygon (MATIC)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="timeframeSelect" class="form-label">æ—¶é—´æ¡†æ¶</label>
                    <select id="timeframeSelect" class="form-select">
                        <option value="1h">1å°æ—¶</option>
                        <option value="4h">4å°æ—¶</option>
                        <option value="1d">1å¤©</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="periodSelect" class="form-label">å†å²å‘¨æœŸ</label>
                    <select id="periodSelect" class="form-select">
                        <option value="7d">7å¤©</option>
                        <option value="30d" selected>30å¤©</option>
                        <option value="90d">90å¤©</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button id="analyzeBtn" class="btn btn-primary w-100">
                        <span id="analyzeText">ğŸ“Š å¼€å§‹åˆ†æ</span>
                        <span id="analyzeSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- é”™è¯¯æ¶ˆæ¯ -->
        <div id="errorMessage" class="error-message d-none"></div>

        <!-- ä¸»è¦æŒ‡æ ‡å¡ç‰‡ -->
        <div id="indicatorsSection" class="d-none">
            <div class="row">
                <!-- RSI -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body indicator-card">
                            <div class="indicator-label">RSI (14)</div>
                            <div id="rsiValue" class="indicator-value">--</div>
                            <div id="rsiSignal" class="signal-badge signal-neutral">ä¸­æ€§</div>
                        </div>
                    </div>
                </div>
                
                <!-- MACD -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body indicator-card">
                            <div class="indicator-label">MACD</div>
                            <div id="macdValue" class="indicator-value">--</div>
                            <div id="macdSignal" class="signal-badge signal-neutral">ä¸­æ€§</div>
                        </div>
                    </div>
                </div>
                
                <!-- å¸ƒæ—å¸¦ -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body indicator-card">
                            <div class="indicator-label">å¸ƒæ—å¸¦ä½ç½®</div>
                            <div id="bbValue" class="indicator-value">--</div>
                            <div id="bbSignal" class="signal-badge signal-neutral">ä¸­æ€§</div>
                        </div>
                    </div>
                </div>
                
                <!-- ç§»åŠ¨å¹³å‡çº¿ -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body indicator-card">
                            <div class="indicator-label">MAè¶‹åŠ¿</div>
                            <div id="maValue" class="indicator-value">--</div>
                            <div id="maSignal" class="signal-badge signal-neutral">ä¸­æ€§</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æŒ‡æ ‡è¡¨æ ¼ -->
        <div id="detailsSection" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“ˆ è¯¦ç»†æŠ€æœ¯æŒ‡æ ‡</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>æŒ‡æ ‡</th>
                                        <th>æ•°å€¼</th>
                                        <th>ä¿¡å·</th>
                                    </tr>
                                </thead>
                                <tbody id="indicatorsTable">
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ğŸ¯ ç»¼åˆäº¤æ˜“ä¿¡å·</h6>
                                </div>
                                <div class="card-body">
                                    <div id="overallSignal" class="text-center">
                                        <div class="indicator-value">åˆ†æä¸­...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div id="chartSection" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“Š ä»·æ ¼èµ°åŠ¿ä¸æŠ€æœ¯æŒ‡æ ‡</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½ä¿¡æ¯ -->
        <div id="performanceSection" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">âš¡ æ€§èƒ½ä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>æ•°æ®ç‚¹æ•°:</strong>
                            <span id="dataPoints">--</span>
                        </div>
                        <div class="col-md-3">
                            <strong>è®¡ç®—è€—æ—¶:</strong>
                            <span id="calculationTime">--</span>
                        </div>
                        <div class="col-md-3">
                            <strong>åˆ†ææ—¶é—´:</strong>
                            <span id="analysisTime">--</span>
                        </div>
                        <div class="col-md-3">
                            <strong>çŠ¶æ€:</strong>
                            <span id="analysisStatus" class="badge bg-success">å°±ç»ª</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentChart = null;
        let currentData = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šäº‹ä»¶
            document.getElementById('analyzeBtn').addEventListener('click', performAnalysis);
            
            // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡åˆ†æ
            performAnalysis();
        });

        // æ‰§è¡ŒæŠ€æœ¯åˆ†æ
        async function performAnalysis() {
            const symbol = document.getElementById('symbolSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const period = document.getElementById('periodSelect').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);
            hideError();

            try {
                // è°ƒç”¨API
                const response = await fetch('/api/v1/technical-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        period: period
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ˜¾ç¤ºç»“æœ
                    displayResults(data);
                    
                    // è·å–å†å²æ•°æ®ç”¨äºå›¾è¡¨
                    await loadHistoricalData(symbol, timeframe, period);
                } else {
                    showError(data.error || 'åˆ†æå¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                showError('ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸');
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayResults(data) {
            // æ›´æ–°ä¸»è¦æŒ‡æ ‡å¡ç‰‡
            updateIndicatorCards(data.indicators, data.signals);
            
            // æ›´æ–°è¯¦ç»†è¡¨æ ¼
            updateDetailsTable(data.indicators, data.signals);
            
            // æ›´æ–°æ€§èƒ½ä¿¡æ¯
            updatePerformanceInfo(data);
            
            // æ˜¾ç¤ºå„ä¸ªåŒºåŸŸ
            document.getElementById('indicatorsSection').classList.remove('d-none');
            document.getElementById('detailsSection').classList.remove('d-none');
            document.getElementById('performanceSection').classList.remove('d-none');
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            document.getElementById('lastUpdate').textContent = 
                `æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;
        }

        // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
        function updateIndicatorCards(indicators, signals) {
            // RSI
            if (indicators.rsi !== undefined) {
                document.getElementById('rsiValue').textContent = indicators.rsi.toFixed(2);
                updateSignalBadge('rsiSignal', signals.rsi);
            }

            // MACD
            if (indicators.macd) {
                const macdValue = indicators.macd.histogram.toFixed(2);
                document.getElementById('macdValue').textContent = macdValue;
                updateSignalBadge('macdSignal', signals.macd);
            }

            // å¸ƒæ—å¸¦ (è¿™é‡Œç®€åŒ–æ˜¾ç¤ºä¸­è½¨å€¼)
            if (indicators.bollinger_bands) {
                const bbValue = indicators.bollinger_bands.middle.toFixed(2);
                document.getElementById('bbValue').textContent = bbValue;
                updateSignalBadge('bbSignal', signals.bollinger || 'neutral');
            }

            // ç§»åŠ¨å¹³å‡çº¿
            if (indicators.sma_20 && indicators.sma_50) {
                const trend = indicators.sma_20 > indicators.sma_50 ? 'ä¸Šå‡' : 'ä¸‹é™';
                document.getElementById('maValue').textContent = trend;
                const signal = indicators.sma_20 > indicators.sma_50 ? 'bullish' : 'bearish';
                updateSignalBadge('maSignal', signal);
            }
        }

        // æ›´æ–°ä¿¡å·å¾½ç« 
        function updateSignalBadge(elementId, signal) {
            const element = document.getElementById(elementId);
            element.className = 'signal-badge';
            
            switch(signal) {
                case 'bullish':
                    element.classList.add('signal-bullish');
                    element.textContent = 'çœ‹æ¶¨';
                    break;
                case 'bearish':
                    element.classList.add('signal-bearish');
                    element.textContent = 'çœ‹è·Œ';
                    break;
                case 'overbought':
                    element.classList.add('signal-overbought');
                    element.textContent = 'è¶…ä¹°';
                    break;
                case 'oversold':
                    element.classList.add('signal-oversold');
                    element.textContent = 'è¶…å–';
                    break;
                default:
                    element.classList.add('signal-neutral');
                    element.textContent = 'ä¸­æ€§';
            }
        }

        // æ›´æ–°è¯¦ç»†è¡¨æ ¼
        function updateDetailsTable(indicators, signals) {
            const tbody = document.getElementById('indicatorsTable');
            tbody.innerHTML = '';

            const indicatorList = [
                { key: 'rsi', name: 'RSI (14)', format: (v) => v.toFixed(2) },
                { key: 'macd', name: 'MACD', format: (v) => v.macd.toFixed(2) },
                { key: 'sma_20', name: 'SMA (20)', format: (v) => v.toFixed(2) },
                { key: 'ema_12', name: 'EMA (12)', format: (v) => v.toFixed(2) },
                { key: 'stochastic', name: 'Stochastic K', format: (v) => v.k.toFixed(2) },
                { key: 'williams_r', name: 'Williams %R', format: (v) => v.toFixed(2) },
                { key: 'cci', name: 'CCI', format: (v) => v.toFixed(2) },
                { key: 'momentum', name: 'Momentum', format: (v) => v.toFixed(2) }
            ];

            indicatorList.forEach(indicator => {
                if (indicators[indicator.key] !== undefined) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${indicator.name}</td>
                        <td>${indicator.format(indicators[indicator.key])}</td>
                        <td><span class="signal-badge signal-neutral">${getSignalText(signals[indicator.key] || 'neutral')}</span></td>
                    `;
                }
            });

            // æ›´æ–°ç»¼åˆä¿¡å·
            updateOverallSignal(signals);
        }

        // æ›´æ–°ç»¼åˆä¿¡å·
        function updateOverallSignal(signals) {
            const signalValues = Object.values(signals);
            const bullishCount = signalValues.filter(s => s === 'bullish').length;
            const bearishCount = signalValues.filter(s => s === 'bearish').length;
            
            let overallSignal = 'neutral';
            let signalText = 'ä¸­æ€§';
            
            if (bullishCount > bearishCount) {
                overallSignal = 'bullish';
                signalText = 'çœ‹æ¶¨';
            } else if (bearishCount > bullishCount) {
                overallSignal = 'bearish';
                signalText = 'çœ‹è·Œ';
            }

            const element = document.getElementById('overallSignal');
            element.innerHTML = `
                <div class="indicator-value">${signalText}</div>
                <div class="small text-muted">
                    çœ‹æ¶¨ä¿¡å·: ${bullishCount} | çœ‹è·Œä¿¡å·: ${bearishCount}
                </div>
            `;
        }

        // è·å–ä¿¡å·æ–‡æœ¬
        function getSignalText(signal) {
            const signalMap = {
                'bullish': 'çœ‹æ¶¨',
                'bearish': 'çœ‹è·Œ',
                'overbought': 'è¶…ä¹°',
                'oversold': 'è¶…å–',
                'neutral': 'ä¸­æ€§'
            };
            return signalMap[signal] || 'ä¸­æ€§';
        }

        // æ›´æ–°æ€§èƒ½ä¿¡æ¯
        function updatePerformanceInfo(data) {
            document.getElementById('dataPoints').textContent = data.data_points_used;
            document.getElementById('calculationTime').textContent = `${data.calculation_time_ms.toFixed(2)}ms`;
            document.getElementById('analysisTime').textContent = new Date(data.timestamp).toLocaleString();
            document.getElementById('analysisStatus').textContent = 'å®Œæˆ';
        }

        // åŠ è½½å†å²æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨
        async function loadHistoricalData(symbol, timeframe, period) {
            try {
                const response = await fetch(`/api/v1/historical-data?symbol=${symbol}&timeframe=${timeframe}&period=${period}`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    drawChart(data.data, symbol);
                    document.getElementById('chartSection').classList.remove('d-none');
                }
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            }
        }

        // ç»˜åˆ¶ä»·æ ¼å›¾è¡¨
        function drawChart(data, symbol) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (currentChart) {
                currentChart.destroy();
            }

            // å‡†å¤‡æ•°æ®
            const labels = data.map(d => new Date(d.timestamp * 1000));
            const prices = data.map(d => d.close);

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${symbol} ä»·æ ¼`,
                        data: prices,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'MM-dd HH:mm',
                                    day: 'MM-dd'
                                }
                            }
                        },
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const btn = document.getElementById('analyzeBtn');
            const text = document.getElementById('analyzeText');
            const spinner = document.getElementById('analyzeSpinner');

            if (show) {
                btn.disabled = true;
                text.textContent = 'åˆ†æä¸­...';
                spinner.classList.remove('d-none');
            } else {
                btn.disabled = false;
                text.textContent = 'ğŸ“Š å¼€å§‹åˆ†æ';
                spinner.classList.add('d-none');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = `âŒ ${message}`;
            errorDiv.classList.remove('d-none');
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('errorMessage').classList.add('d-none');
        }
    </script>
</body>
</html>